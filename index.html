<!DOCTYPE html>
<html>
<head>
	<title>Level Maker</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type="text/javascript" src="class.js"></script>
</head>

<body>

<div>
	<input type="number" placeholder="Width" id="cWidth"></input>
	<input type="number" placeholder="Height" id="cHeight"></input>
	<button onclick="start()">Create</button>
	<button onclick="save()">Save</button>
	<a download="level.JSON" id="download">Download</a>
</div>

<div>
	<select id="select" onchange="setTile()">
		<option>Erase</option>
		<option>Player</option>
		<option>Space Goblin</option>
		<option>Wall</option>
		<option>Portal</option>
	</select>
	<input type="range" id="myRange" value="1" oninput="sliderUpdate()" step="0.01" min="0.5" max="5">
	<p id="rangeVal">1</p>
</div>

<script type="text/javascript">
function sliderUpdate() {
	document.getElementById('rangeVal').innerHTML = document.getElementById('myRange').value;
	tileSize = StartTileSize*document.getElementById('myRange').value;
	start();
}
var e = document.getElementById("select");
var selectedTile = e.selectedIndex;
function setTile() {
	selectedTile = e.selectedIndex;
}
var colors = ["#FFFFFF", "#00FF00", "#FF0000", "#0000FF", "#FF00FF"];

var obj = {
	board:[],
};



function start() {
	Editor.start();
}

var StartTileSize = 16;
var tileSize = StartTileSize;

var Editor = {
	canvas : document.createElement("canvas"),
	start : function() {
		this.canvas.width = tileSize*document.getElementById('cWidth').value;
		this.canvas.height = tileSize*document.getElementById('cHeight').value;
		this.ctx = this.canvas.getContext("2d");
		document.body.insertBefore(this.canvas, document.body.childNodes[0]);
		this.drawGrid();
		this.draw();
		this.mouseUpdate();
	},
	clear : function() {
		this.canvas.width = this.canvas.width;
	},
	draw : function() {
		for (var i=0; i<obj.board.length; i++) {
			this.ctx.fillStyle = colors[obj.board[i].type];
			this.ctx.fillRect(obj.board[i].x*tileSize, obj.board[i].y*tileSize, tileSize, tileSize);
		};
		this.drawGrid();
	},
	drawGrid : function() {
		// Draw grid
		this.ctx.beginPath();
		this.ctx.strokeStyle = "#CCCCCC";
		for (var i = tileSize; i < this.canvas.width; i+=tileSize) {
			this.ctx.moveTo(i, 0);
			this.ctx.lineTo(i, this.canvas.height);
			this.ctx.stroke();
		};
		for (var i = tileSize; i < this.canvas.height; i+=tileSize) {
			this.ctx.moveTo(0, i);
			this.ctx.lineTo(this.canvas.width, i);
			this.ctx.stroke();
		};
	},
	mouseUpdate : function() {
		// Check mouse down
		window.addEventListener("mousedown", Editor.getPosition);
		window.requestAnimationFrame(Editor.mouseUpdate);
	},
	// Get canvas X/Y
	getPosition : function(e) {
	    var x;
	    var y;
	    if (e.pageX || e.pageY) {
			x = e.pageX;
			y = e.pageY;
	    } else {
		x = e.clientX + document.body.scrollLeft +
	        document.documentElement.scrollLeft;
		y = e.clientY + document.body.scrollTop +
	        document.documentElement.scrollTop;
	    }

		// Convert to coordinates relative to the canvas
	    x -= Editor.canvas.offsetLeft;
	    y -= Editor.canvas.offsetTop;

		if (x>=0 && y>=0 && x<=Editor.canvas.width && y<=Editor.canvas.height) {

			x = Math.round((Math.floor(x/tileSize)*tileSize)/tileSize);
			y = Math.round((Math.floor(y/tileSize)*tileSize)/tileSize);

			var overlap = false;
			for (var i = 0; i < obj.board.length; i++) {

				if ( (obj.board[i].x == x) && (obj.board[i].y == y) ) {
					overlap = true;
				}
			}
			if (overlap) {
				removeElement(x, y);
			}

			if (selectedTile!=0) {
				obj.board.push(new Tile( selectedTile, x, y ));
			} else {
				removeElement(x,y);
				Editor.start();
			}

		}
		Editor.draw();
	}

}

function removeElement(x, y) {
	var temp = [];
	for (var i = 0; i < obj.board.length; i++) {
		if ( (obj.board[i].y==y) && (obj.board[i].x==x) ) {
			console.log("Removed index " + i);
		} else {
			temp.push(obj.board[i]);
		}
	}
	console.log(obj.board);
	console.log(temp);
	obj.board = temp;
}

function save() {
	var formBlob = new Blob([JSON.stringify(obj)], { type: 'text/plain' });
	document.getElementById('download').href = window.URL.createObjectURL(formBlob);
}

</script>

</body>


</html>
