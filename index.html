<!DOCTYPE html>
<html>
<head>
	<title>Level Maker</title>
	<link rel="icon" href="favicon.png" type="image/gif">
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type="text/javascript" src="class.js"></script>
</head>

<body>

<div>
	<input type="number" placeholder="Width" id="cWidth"></input>
	<input type="number" placeholder="Height" id="cHeight"></input>
	<button onclick="start()">Create</button>
	<input type="file" id="fileinput" />
</div>

<div>
	<input type="text" id="levelname" placeholder="Level Name" value="level" onchange="updateLevelName()"></input>
	<button onclick="save()">Save</button>
	<a download="level.json" id="download">Download</a>
</div>

<div>
	<select id="select">
		<option value="ERASE">Erase</option>
	</select>
	<input type="range" id="myRange" value="1" oninput="sliderUpdate()" step="0.01" min="0.5" max="5">
	<p id="rangeVal">1</p>
</div>

<div id="attributes">
</div>

<script type="text/javascript">
var DEFAULT_TILES = {
	"Player": {
		"className": "Player",
		"imageURL": "/level_maker/tiles/player.png",
	},
	"Goblin": {
		"className": "Goblin",
		"imageURL": "/level_maker/tiles/space_goblin.png",
	},
	"GoblinSoldier": {
		"className": "GoblinSoldier",
		"imageURL": "/level_maker/tiles/goblin_soldier.png",
	},
	"Wall": {
		"className": "Wall",
		"imageURL": "/level_maker/tiles/wall.png",
	},
	"Crewman": {
		"className": "Crewman",
		"imageURL": "/level_maker/tiles/prisoner.png",
	},
	"JailDoor": {
		"className": "JailDoor",
		"imageURL": "/level_maker/tiles/door.png",
	},
	"Portal": {
		"className": "Portal",
		"imageURL": "/level_maker/tiles/door.png",
	},
};

window.onload = function() {
	var select = document.getElementById("select");
	for (var tile in DEFAULT_TILES) {
		if (DEFAULT_TILES.hasOwnProperty(tile)) {
			var option = document.createElement("option");
			option.dataValue = DEFAULT_TILES[tile];
			option.innerHTML = DEFAULT_TILES[tile].className;
			option.value = DEFAULT_TILES[tile].className;
			select.appendChild(option);
		}
	}

	for (var i = 0; i < e.children.length; i++) {
		if (e.children[i].value!="ERASE") {
			images[i] = new Image();
			images[i].src = e.children[i].value;
		}
	}

	window.addEventListener("mousedown", Editor.mouseTrue);
	window.addEventListener("mouseup", Editor.mouseFalse);
	window.addEventListener("mousemove", Editor.getPosition);
	window.addEventListener("mousedown", Editor.getPosition);

	var select = document.getElementById("select");
	select.addEventListener("change", setTile);
}

function updateLevelName() {
	document.getElementById('download').download=(document.getElementById('levelname').value + ".json");
}

document.getElementById('fileinput').addEventListener('change', readSingleFile, false);
function readSingleFile(evt) {
	var f = evt.target.files[0];
	if (f) {
		var r = new FileReader();
		r.onload = function(e) {
		Editor.loadLevel(e.target.result);
	}
		r.readAsText(f);
	} else {
		alert("Failed to load file");
	}
}

function sliderUpdate() {
	document.getElementById('rangeVal').innerHTML = document.getElementById('myRange').value;
	tileSize = StartTileSize*document.getElementById('myRange').value;
	Editor.start();
}
var e = document.getElementById("select");
var selectedTile = e.selectedIndex;

function attributesToObject() {
	var attributesAsObject = {};
	var attributes = document.getElementById("attributes");
	console.log(attributes.childNodes);
	for (var i = 0; i < attributes.childNodes.length; i++) {
		var propDiv = attributes.childNodes[i];
		console.log(propDiv.label.innerText, propDiv.value.value);
		attributesAsObject[propDiv.label.innerText] = propDiv.value.value;
	}
	return attributesAsObject;
}

function populateAttributes(createClassOptions) {
	var attributes = document.getElementById("attributes");
	attributes.innerHTML = "";
	for (var prop in createClassOptions) {
		if (createClassOptions.hasOwnProperty(prop)) {
			var propDiv = addAttribute();
			propDiv.label.innerText = prop;
			propDiv.value.value = createClassOptions[prop];
		}
	}
	console.log(attributesToObject());
	return attributes;
}

function addAttribute() {
	var attributes = document.getElementById("attributes");

	var propDiv = document.createElement("div");
	attributes.appendChild(propDiv);

	var label = document.createElement("p");
	label.setAttribute("contentEditable", true);
	label.innerText = "Key";
	propDiv.appendChild(label);
	propDiv.label = label;

	var value = document.createElement("input");
	value.value = "Value";
	propDiv.appendChild(value);
	propDiv.value = value;

	return propDiv;
}

function setTile() {
	var createClassOptions = e.options[e.selectedIndex].dataValue;
	console.log(createClassOptions);
	populateAttributes(createClassOptions);
	selectedTile = e.selectedIndex;
}

var images = [];



var obj = {
	width:0,
	height:0,
	board:[],
};

function start() {
	Editor.start();
}

var StartTileSize = 16;
var tileSize = StartTileSize;

var Editor = {
	mousedown : false,
	canvas : document.createElement("canvas"),
	start : function() {
		this.canvas.width = tileSize*document.getElementById('cWidth').value;
		this.canvas.height = tileSize*document.getElementById('cHeight').value;
		this.ctx = this.canvas.getContext("2d");
		document.body.insertBefore(this.canvas, document.body.childNodes[0]);
		this.drawGrid();
		this.draw();
	},
	clear : function() {
		this.canvas.width = this.canvas.width;
	},
	draw : function() {
		Editor.clear();
		for (var i=0; i<obj.board.length; i++) {
			if (images[obj.board[i].imgIndex]=="ERASE") {
				this.ctx.fillStyle = "#FFFFFF";
				this.ctx.fillRect(obj.board[i].x*tileSize, obj.board[i].y*tileSize, tileSize, tileSize);
			} else {
				this.ctx.drawImage(obj.board[i].image, obj.board[i].x*tileSize, obj.board[i].y*tileSize, tileSize, tileSize);
			}
		};

		this.drawGrid();
	},
	drawGrid : function() {
		// Draw grid
		this.ctx.beginPath();
		this.ctx.strokeStyle = "#CCCCCC";
		for (var i = tileSize; i < this.canvas.width; i+=tileSize) {
			this.ctx.moveTo(i, 0);
			this.ctx.lineTo(i, this.canvas.height);
			this.ctx.stroke();
		};
		for (var i = tileSize; i < this.canvas.height; i+=tileSize) {
			this.ctx.moveTo(0, i);
			this.ctx.lineTo(this.canvas.width, i);
			this.ctx.stroke();
		};
	},
	loadLevel : function(file) {
		obj = JSON.parse(file);
		document.getElementById('cWidth').value = obj.width;
		document.getElementById('cHeight').value = obj.height;
		Editor.start();
	},
	mouseTrue : function() {
		Editor.mousedown = true;
	},
	mouseFalse : function() {
		Editor.mousedown = false;
	},
	// Get canvas X/Y
	getPosition : function(e) {
		if (Editor.mousedown) {
		    var x;
		    var y;
		    if (e.pageX || e.pageY) {
				x = e.pageX;
				y = e.pageY;
		    } else {
			x = e.clientX + document.body.scrollLeft +
		        document.documentElement.scrollLeft;
			y = e.clientY + document.body.scrollTop +
		        document.documentElement.scrollTop;
		    }

			// Convert to coordinates relative to the canvas
		    x -= Editor.canvas.offsetLeft;
		    y -= Editor.canvas.offsetTop;

			if (x>=0 && y>=0 && x<=Editor.canvas.width && y<=Editor.canvas.height) {

				x = Math.round((Math.floor(x/tileSize)*tileSize)/tileSize);
				y = Math.round((Math.floor(y/tileSize)*tileSize)/tileSize);

				var overlap = false;
				for (var i = 0; i < obj.board.length; i++) {

					if ( (obj.board[i].x == x) && (obj.board[i].y == y) ) {
						overlap = true;
					}
				}
				if (overlap) {
					removeElement(x, y);
				}

				if (selectedTile!=0) {
					var createClassOptions = attributesToObject();

					obj.board.push(new Tile(createClassOptions, x, y ));
				} else {
					removeElement(x,y);
					Editor.clear();
				}

			}
			Editor.draw();
		}
	}

}

function removeElement(x, y) {
	var temp = [];
	for (var i = 0; i < obj.board.length; i++) {
		if ( (obj.board[i].y==y) && (obj.board[i].x==x) ) {
			console.log("Removed index " + i);
		} else {
			temp.push(obj.board[i]);
		}
	}
	obj.board = temp;
}

function save() {
	obj.width = document.getElementById('cWidth').value;
	obj.height = document.getElementById('cHeight').value;

	var formBlob = new Blob([JSON.stringify(obj)], { type: 'text/plain' });
	document.getElementById('download').href = window.URL.createObjectURL(formBlob);
}

</script>

</body>


</html>
